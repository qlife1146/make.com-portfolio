<!DOCTYPE html>
<html>
  <body style="font: 12px sans-serif; padding: 12px">
    <div style="display: flex; flex-direction: column; gap: 8px">
      <div style="display: flex; gap: 8px">
        <button id="refresh" style="padding: 8px">ìƒˆë¡œê³ ì¹¨</button>
        <button id="downloadPng" style="padding: 8px">PNG ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <pre
        id="log"
        style="
          white-space: pre-wrap;
          background: #f5f5f5;
          padding: 8px;
          border-radius: 6px;
          height: 250px;
          overflow: auto;
        "
      ></pre>

      <!-- URL ì…ë ¥ íŒ¨ë„ -->
      <div
        id="urlPanel"
        style="
          display: none;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 10px;
        "
      >
        <div style="margin-bottom: 6px; font-weight: 600">
          Make Webhook URLì„ ì…ë ¥í•˜ì„¸ìš”
        </div>

        <input
          id="webhookUrl"
          placeholder="https://hook.us2.make.com/xxxxx"
          style="
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box;
          "
        />

        <div style="display: flex; gap: 8px; margin-top: 8px">
          <button id="tryUrl" style="padding: 8px; flex: 1">
            ì´ URLë¡œ ì‹œë„
          </button>
          <button id="clearUrl" style="padding: 8px">ì €ì¥ê°’ ì‚­ì œ</button>
        </div>

        <div style="margin-top: 6px; color: #666; font-size: 11px">
          âœ… ì„±ê³µí–ˆì„ ë•Œë§Œ ì €ì¥ë©ë‹ˆë‹¤. (ì‹¤íŒ¨ ì‹œ ì €ì¥ ì•ˆ í•¨)
        </div>
      </div>
    </div>

    <script>
      const TARGET_NODE_ID = "1-2"; // export target (ui -> code.js will convert to 1:2)

      const logEl = document.getElementById("log");
      const refreshBtn = document.getElementById("refresh");
      const downloadBtn = document.getElementById("downloadPng");

      const urlPanel = document.getElementById("urlPanel");
      const urlEl = document.getElementById("webhookUrl");
      const tryUrlBtn = document.getElementById("tryUrl");
      const clearUrlBtn = document.getElementById("clearUrl");

      let running = false;
      let pendingUrlToSave = null;

      function log(msg) {
        logEl.textContent += msg + "\n";
      }
      function resetLog() {
        logEl.textContent = "";
      }
      function showUrlPanel(reason) {
        urlPanel.style.display = "block";
        if (reason) log("âš ï¸ " + reason);
      }
      function hideUrlPanel() {
        urlPanel.style.display = "none";
      }

      function requestSavedUrlAndRun() {
        parent.postMessage({ pluginMessage: { type: "GET_SAVED_URL" } }, "*");
      }

      function runWebhookWithUrl(url) {
        const u = (url || "").trim();
        if (!u) {
          showUrlPanel("URLì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
          return;
        }
        if (running) return;

        running = true;
        pendingUrlToSave = u;

        resetLog();
        log("â¡ï¸ ìš”ì²­ ë³´ëƒ„: " + u);

        parent.postMessage({ pluginMessage: { type: "RUN", url: u } }, "*");
      }

      function downloadPng() {
        resetLog();
        log("â¬‡ï¸ PNG ë‚´ë³´ë‚´ëŠ” ì¤‘... node_id=" + TARGET_NODE_ID);

        parent.postMessage(
          { pluginMessage: { type: "EXPORT_PNG", nodeId: TARGET_NODE_ID } },
          "*"
        );
      }

      // ì´ˆê¸° ì‹¤í–‰: ì €ì¥ëœ URLë¡œ ìë™ ì‹¤í–‰ (ì—†ìœ¼ë©´ ì…ë ¥ì°½ í‘œì‹œ)
      window.onload = () => {
        requestSavedUrlAndRun();
      };

      refreshBtn.onclick = () => {
        requestSavedUrlAndRun();
      };

      refreshBtn.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showUrlPanel("URLì„ ì…ë ¥/ìˆ˜ì •í•˜ì„¸ìš”");
        urlEl.focus();
        urlEl.select();
      });

      downloadBtn.onclick = () => downloadPng();

      tryUrlBtn.onclick = () => {
        hideUrlPanel();
        runWebhookWithUrl(urlEl.value);
      };

      clearUrlBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: "CLEAR_SAVED_URL" } }, "*");
        pendingUrlToSave = null;
        resetLog();
        showUrlPanel("ì €ì¥ëœ URLì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ìƒˆ URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      };

      urlEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          tryUrlBtn.click();
        }
      });

      function base64ToBlob(base64, mime) {
        const bin = atob(base64);
        const len = bin.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
        return new Blob([bytes], { type: mime });
      }

      function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "LOG") log(msg.text);

        if (msg.type === "SAVED_URL") {
          const saved = (msg.url || "").trim();
          if (!saved) {
            resetLog();
            showUrlPanel(
              "ì €ì¥ëœ Webhook URLì´ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ í›„ ì‹œë„í•´ ì£¼ì„¸ìš”."
            );
            running = false;
            return;
          }
          urlEl.value = saved;
          hideUrlPanel();
          runWebhookWithUrl(saved);
          return;
        }

        if (msg.type === "DONE") {
          log("âœ… ì™„ë£Œ");
          running = false;

          // âœ… ì„±ê³µí–ˆì„ ë•Œë§Œ ì €ì¥
          if (pendingUrlToSave) {
            parent.postMessage(
              {
                pluginMessage: { type: "SET_SAVED_URL", url: pendingUrlToSave },
              },
              "*"
            );
            log("ğŸ’¾ URL ì €ì¥ ìš”ì²­");
            pendingUrlToSave = null;
          }

          hideUrlPanel();
          return;
        }

        if (msg.type === "ERROR") {
          running = false;

          const err = String(msg.text || "");
          resetLog();
          log("âŒ " + err);

          // ì–´ë–¤ ERRORë“  URL ì…ë ¥ íŒ¨ë„ í‘œì‹œ (ìš”êµ¬ì‚¬í•­)
          showUrlPanel(
            err.includes("Accepted") || err.includes("Unexpected token")
              ? "ì‘ë‹µì´ JSONì´ ì•„ë‹ˆê±°ë‚˜ URLì´ ì˜ëª»ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. URLì„ ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”."
              : "ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ ë‹¤ì‹œ ì…ë ¥í•´ ì‹œë„í•´ ì£¼ì„¸ìš”."
          );

          pendingUrlToSave = null;
          return;
        }

        if (msg.type === "PNG_READY") {
          const blob = base64ToBlob(msg.base64, "image/png");
          triggerDownload(blob, msg.filename || "export.png");
          log("âœ… PNG ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: " + (msg.filename || "export.png"));
          return;
        }
      };
    </script>
  </body>
</html>
